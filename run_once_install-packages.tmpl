#!/bin/sh

#############################################################
# Functions
#############################################################

# Handy yes/no dialog to let the user make some decisions
dialog_yes_no() {
    echo -e "\n$1 (y/N)? "
    read answer
    if [ "$answer" != "${answer#[Yy]}" ] ;then
        return 0
    else
        return 1
    fi
}


{{ if eq .install_package "ask" -}}
if ! dialog_yes_no "Do you want to run the install script"; then
    exit 0
fi
{{ else if eq .install_package "disabled" -}}
exit 0
{{ else if ne .install_package "enabled" -}}
echo "Unrecognized value for \"system_config\""
exit 1
{{ end -}}


# Trim leading pattern
trim_leading() {
    local pattern="$1"
    shift 1
    local res="${@##*$pattern}"
    echo "$res"
}

# Trim trailing pattern
trim_trailing() {
    local pattern="$1"
    shift 1
    local res="${@%$pattern}"
    echo "$res"
}

# Only install aur packages if they are not installed
paru_needed() {
    local packages="$(paru -Qi $@ 2>&1 >/dev/null)"
    local needed=""

    while read -r p; do
        tmp=$(trim_leading "error: package \'" "$p")
        needed="$needed $(trim_trailing "\' was not found" "$tmp")"
    done <<< "$packages"

    paru -S --needed $needed
}

#############################################################
# ARCHLINUX - MANJARO
#############################################################

# Install key to enable chaotic-aur repo (https://lonewolf.pedrohlc.com/chaotic-aur/)
sudo pacman-key --init
sudo pacman-key --keyserver hkp://keyserver.ubuntu.com -r 3056513887B78AEB 8A9E14A07010F7E3
sudo pacman-key --lsign-key FBA220DFC880C036

# Install keyring and mirrolist
sudo pacman --needed -U "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst" "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"

# Edit pacman .conf
if ! grep --silent "Include = /etc/pacman.d/chaotic-mirrorlist" /etc/pacman.conf; then
    echo -e "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist\n" | sudo tee -a /etc/pacman.conf
fi

# Sync databases
sudo pacman -Syyu

# Install paru
sudo pacman -S --needed paru

paru_needed ripgrep bash git fd fzf exa fish bat neovim yarn fakeroot binutils ufw htop starship asdf-vm powerpill screen bpython git-delta xclip highlight openssh

# snap-pac : setup pre/post btrfs snapshots using pacman hooks
{{ if eq .filesystem "btrfs" -}}
paru_needed snap-pac snapper snapper-gui-git btrfs-du
{{ end -}}


#############################################################
# POST INSTALL CONFIGURATION
#############################################################

# Yarn
yarn config set prefix $HOME/.yarn

# Directories
mkdir -p "$HOME/.local/chezmoi_system"
mkdir -p "$HOME/.ssh/sockets"

# Enable firewall
{{ if ne .wsl "true" -}}
sudo ufw enable
{{ end -}}


# Filesystem stuff
{{ if and (eq .filesystem "btrfs") (ne .wsl "true") -}}
sudo systemctl enable snapper-timeline.timer
{{ end -}}
