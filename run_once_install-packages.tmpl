#!/bin/sh

#############################################################
# Functions
#############################################################

# Handy yes/no dialog to let the user make some decisions
dialog_yes_no() {
    echo -e "\n$1 (y/N)? "
    read answer
    if [ "$answer" != "${answer#[Yy]}" ] ;then
        return 0
    else
        return 1
    fi
}


{{ if eq .install_package "ask" -}}
if ! dialog_yes_no "Do you want to run the install script"; then
    exit 0
fi
{{ else if eq .install_package "disabled" -}}
exit 0
{{ else if ne .install_package "enabled" -}}
echo "Unrecognized value for \"system_config\""
exit 1
{{ end -}}


# Trim leading pattern
trim_leading() {
    local pattern="$1"
    shift 1
    local res="${@##*$pattern}"
    echo "$res"
}

# Trim trailing pattern
trim_trailing() {
    local pattern="$1"
    shift 1
    local res="${@%$pattern}"
    echo "$res"
}

# Only install aur packages if they are not installed
paru_needed() {
    local packages="$(paru -Qi $@ 2>&1 >/dev/null)"
    local needed=""

    while read -r p; do
        tmp=$(trim_leading "error: package \'" "$p")
        needed="$needed $(trim_trailing "\' was not found" "$tmp")"
    done <<< "$packages"

    paru -S --needed $needed
}

#############################################################
# ARCHLINUX - MANJARO
#############################################################

# Install key to enable chaotic-aur repo (https://lonewolf.pedrohlc.com/chaotic-aur/)
sudo pacman-key --init
sudo pacman-key --keyserver hkp://keyserver.ubuntu.com -r 3056513887B78AEB 8A9E14A07010F7E3
sudo pacman-key --lsign-key 3056513887B78AEB

# Sync databases
sudo pacman -Syyu

# Install keyring and mirrolist
sudo pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst" "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"

# Install yay
sudo pacman -S --needed paru

paru_needed ripgrep bash git fd fzf exa fish bat neovim yarn fakeroot binutils ufw htop yay starship-bin asdf-vm powerpill screen bpython git-delta xclip highlight


{{ if eq .machine "desktop" -}}
paru_needed cups avahi imwheel profile-cleaner profile-sync-daemon pamac-aur meld chromium gnome-tweaks geany gksu ttf-bitstream-vera noto-fonts visual-studio-code-bin ttf-twemoji menulibre blueman pulseaudio-modules-bt-git archlinux-appstream-data-pamac gtk2


{{ if eq .vulkan "true" -}}
sudo pacman -S --needed vulkan-icd-loader

{{ if eq .graphics "nvidia" -}}
paru_needed nvidia-utils

{{ else if eq .graphics "intel" -}}
sudo pacman -S --needed vulkan-intel
{{ end -}}

{{ end -}}

{{ if eq .video_acceleration "true" -}}
# Provide "vdpauinfo" an "vainfo" commands
sudo pacman -S --needed libva-utils vdpauinfo

{{ if eq .graphics "intel" -}}
sudo pacman -S --needed intel-media-driver
{{ end -}}

{{ end -}}

{{ end -}}


# snap-pac : setup pre/post btrfs snapshots using pacman hooks
{{ if eq .filesystem "btrfs" -}}
paru_needed snap-pac snapper snapper-gui-git btrfs-du
{{ end -}}


#############################################################
# POST INSTALL CONFIGURATION
#############################################################

# Yarn
yarn config set prefix $HOME/.yarn

# Directories
mkdir -p "$HOME/.local/chezmoi_system"
mkdir -p "$HOME/.ssh/sockets"

# Enable firewall
sudo ufw enable

# Enable systemd services, set default applications
{{ if eq .machine "desktop" -}}

# Enable auto discovery of printers
sudo systemctl enable --now cups-browsed.service cups.socket cups.service cups.path avahi-daemon.service
systemctl --user enable profile-cleaner.service profile-cleaner.timer psd.service bridge-cli.service

{{ end -}}


# Filesystem stuff
{{ if eq .filesystem "btrfs" -}}
sudo systemctl enable snapper-timeline.timer
{{ end -}}


# Activate evo 4 pulseaudio profile
{{ if eq .evo4 "true" -}}
sudo udevadm control --reload
sudo udevadm trigger --subsystem-match=sound
pulseaudio --kill
{{ end -}}

{{ if eq .hblock "true" -}}
paru -S --needed hblock curl
curl -o '/tmp/hblock.#1' 'https://raw.githubusercontent.com/hectorm/hblock/v3.2.2/resources/systemd/hblock.{service,timer}' \
  && sudo mv /tmp/hblock.{service,timer} /etc/systemd/system/ \
  && sudo chown 0:0 /etc/systemd/system/hblock.{service,timer} \
  && sudo chmod 644 /etc/systemd/system/hblock.{service,timer} \
  && sudo systemctl daemon-reload \
  && sudo systemctl enable hblock.timer \
  && sudo systemctl start hblock.timer
{{ end -}}
